========================================
CORRECTIONS APPLIQU√âES
========================================

1. ERREUR SQL : Colonne inexistante (CORRIG√â)
   ----------------------------------------
   Probl√®me : numero_piece_identite n'existe pas
   Solution : Utilise maintenant "nir" (Num√©ro de s√©curit√© sociale)

   Fichiers corrig√©s :
   - VERIFIER-DONNEES-PROFIL-CDI.sql
   - supabase/functions/create-yousign-signature/index.ts
   - FIX-VARIABLES-CDI-NON-REMPLIES.md
   - SOLUTION-VARIABLES-CDI.md

   Action requise :
   Red√©ployer la fonction Edge :
   supabase functions deploy create-yousign-signature

2. SUPPRESSION DE CONTRATS (NOUVEAU)
   ---------------------------------
   Fonctionnalit√© : Supprimer TOUS les contrats sans contraintes

   Changements :
   ‚úì Bouton "Supprimer" visible pour TOUS les contrats
   ‚úì Supprime les contrats manuels ET g√©n√©r√©s (Yousign)
   ‚úì Nettoie les fichiers du storage automatiquement
   ‚úì Bouton "Renvoyer" pour renvoyer le m√™me mod√®le

   Fichier modifi√© :
   - src/components/EmployeeList.tsx

   Utilisation :
   1. Ouvrir le modal du salari√©
   2. Cliquer sur "Supprimer" (bouton rouge)
   3. Confirmer la suppression
   4. Utiliser "Renvoyer" pour renvoyer le m√™me mod√®le

3. BOUTON T√âL√âCHARGER TOUJOURS VISIBLE (NOUVEAU)
   --------------------------------------------
   Fonctionnalit√© : T√©l√©charger n'importe quel contrat

   Changements :
   ‚úì Bouton "T√©l√©charger" visible pour TOUS les statuts
   ‚úì T√©l√©charge le PDF s'il existe
   ‚úì G√©n√®re le PDF √† la demande si n√©cessaire (retourne blob)
   ‚úì Fonctionne pour contrats sign√©s et non sign√©s
   ‚úì N'utilise PAS Yousign (utilise generate-contract-pdf)

   Fichier modifi√© :
   - src/components/EmployeeList.tsx (lignes 3996-4032)

   Utilisation :
   1. Ouvrir le modal du salari√©
   2. Cliquer sur "T√©l√©charger" (bouton bleu)
   3. Le PDF est t√©l√©charg√© ou g√©n√©r√© automatiquement

4. FIX ERREUR YOUSIGN CDI (NOUVEAU)
   ---------------------------------
   Probl√®me : Erreur "DOCX download failed: 400 Bad Request"
   Lors de l'envoi de contrats CDI √† Yousign

   Diagnostic :
   ‚úì Les fichiers DOCX EXISTENT dans le storage
   ‚úó Le bucket "modeles-contrats" N'EST PAS PUBLIC
   ‚Üí Les fichiers ne sont pas accessibles via leur URL publique

   SOLUTION 1 (RECOMMAND√âE) : Rendre le bucket public
   ‚úì Corriger les permissions du bucket via Dashboard ou SQL
   ‚úì R√©sout le probl√®me d√©finitivement
   ‚úì Utilise les vrais fichiers DOCX avec leur mise en forme
   ‚úì Simple et rapide (2 minutes)

   Fichiers cr√©√©s :
   - FIX-BUCKET-MODELES-CONTRATS-PERMISSIONS.sql : Script SQL
   - TESTER-ACCES-FICHIERS-CDI.sh : Script de test des URLs

   Action requise (Option A - Dashboard) :
   1. Supabase Dashboard ‚Üí Storage
   2. Bucket "modeles-contrats" ‚Üí Settings ‚öôÔ∏è
   3. Cocher "Public bucket"
   4. Sauvegarder

   Action requise (Option B - SQL) :
   Ex√©cuter : FIX-BUCKET-MODELES-CONTRATS-PERMISSIONS.sql

   SOLUTION 2 (SECOURS) : Fallback HTML‚ÜíPDF
   ‚úì Si DOCX inaccessible ‚Üí g√©n√®re PDF depuis HTML automatiquement
   ‚úì Fonctionne m√™me si bucket priv√©
   ‚úì Filet de s√©curit√© suppl√©mentaire

   Fichier modifi√© :
   - supabase/functions/create-yousign-signature/index.ts
     - Ajout generatePdfFromHtml() (lignes 467-502)
     - Ajout generateContractHTML() (lignes 504-561)
     - D√©tection DOCX inaccessible (lignes 527-547)
     - G√©n√©ration conditionnelle PDF (lignes 610-618)

   Action requise (optionnel) :
   D√©ployer la fonction Edge :
   ./DEPLOYER-FIX-CDI-YOUSIGN-MAINTENANT.sh

5. FIX CARTE INCIDENTS DASHBOARD RH (NOUVEAU)
   -------------------------------------------
   Probl√®me : Carte "Incidents" affichait 260+ incidents au lieu du nombre r√©el
   La carte comptait les incidents legacy de type 'contrat_expirer' (199) et
   'avenant_expirer' (61) qui sont des doublons.

   Solution : Calcul exactement comme la page Incidents
   ‚úì total = docsCount + cddCount + avenantCount
   ‚úì docsCount = incidents de documents (types valides, statuts actifs)
   ‚úì cddCount = get_contrats_expires() RPC
   ‚úì avenantCount = get_avenants_expires() RPC
   ‚úì Types legacy JAMAIS compt√©s

   Fichier modifi√© :
   - src/components/RHDashboard.tsx
     - Fonction fetchIncidentsStats() r√©√©crite (lignes 418-584)
     - Exclusion explicite types legacy
     - Calcul coh√©rent avec page Incidents

   R√©sultat :
   Le nombre d'incidents affich√© dans la carte Dashboard = Nombre page Incidents

R√âSUM√â
------
‚úì Erreur SQL corrig√©e (nir au lieu de numero_piece_identite)
‚úì Suppression de contrats sans contraintes ajout√©e
‚úì Bouton "Renvoyer" pour renvoyer le m√™me mod√®le
‚úì Bouton "T√©l√©charger" toujours visible (tous statuts)
‚úì G√©n√©ration PDF √† la demande pour contrats non sign√©s (blob)
‚úì Fix erreur Yousign CDI (2 solutions disponibles)
‚úì Carte Incidents Dashboard RH corrig√©e (exclut legacy, coh√©rent avec page)
‚úì Build r√©ussi sans erreurs

ACTIONS REQUISES
----------------
‚ö†Ô∏è PRIORIT√â 1 : Rendre le bucket public (SOLUTION 1)
   Via Dashboard OU ex√©cuter FIX-BUCKET-MODELES-CONTRATS-PERMISSIONS.sql

‚ö†Ô∏è PRIORIT√â 2 (Optionnel) : D√©ployer le fallback (SOLUTION 2)
   ./DEPLOYER-FIX-CDI-YOUSIGN-MAINTENANT.sh

üìã Test : ./TESTER-ACCES-FICHIERS-CDI.sh

DOCUMENTATION
-------------
Erreur Yousign CDI :
- LIRE-EN-PREMIER-CDI-YOUSIGN.txt : Guide rapide de d√©marrage
- SOLUTION-COMPLETE-ERREUR-CDI-YOUSIGN.md : Documentation compl√®te
- FIX-BUCKET-MODELES-CONTRATS-PERMISSIONS.sql : Script SQL correction bucket
- TESTER-ACCES-FICHIERS-CDI.sh : Script de test des URLs
- FIX-CDI-YOUSIGN-HTML-FALLBACK.md : Documentation du fallback HTML
- DEPLOYER-FIX-CDI-YOUSIGN-MAINTENANT.sh : D√©ploiement fallback

Dashboard RH - Incidents :
- CORRECTION-DASHBOARD-RH-INCIDENTS.md : Guide complet de la correction
- RESUME-CORRECTION-DASHBOARD-INCIDENTS.txt : R√©sum√© rapide

Autres corrections :
- ERREUR-COLONNE-CORRIGEE.txt : Erreur SQL
- CORRECTION-VARIABLES-CDI-APPLIQUEE.md : D√©tails correction SQL
- SUPPRESSION-CONTRATS-SANS-CONTRAINTES.md : Suppression de contrats
- BOUTON-TELECHARGER-TOUJOURS-VISIBLE.md : T√©l√©chargement universel
